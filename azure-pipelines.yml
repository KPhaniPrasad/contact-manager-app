trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  acrLoginServer: mycontactmanager.azurecr.io          # Replace with your ACR login server
  imageNameFrontend: contact-frontend
  imageNameBackend: contact-backend

steps:

# Install Docker (optional, if not already available)
- task: DockerInstaller@0

# Login to Azure Container Registry
- task: Docker@2
  displayName: Login to ACR
  inputs:
    command: login
    containerRegistry: azure-contact-manager-app        # Replace with your service connection name

# âœ… Pre-test frontend build outside Docker
- task: NodeTool@0
  inputs:
    versionSpec: '18.x'
  displayName: 'Install Node.js for frontend build'

- script: |
    cd frontend
    npm install
    CI=false npm run build --verbose
  displayName: 'Pre-test React frontend build'

# Build backend Docker image
- task: Docker@2
  displayName: Build backend image
  inputs:
    command: build
    Dockerfile: backend/Dockerfile
    tags: |
      $(acrLoginServer)/$(imageNameBackend):$(Build.BuildId)
    buildContext: $(Build.SourcesDirectory)/backend

# Build frontend Docker image
- task: Docker@2
  displayName: Build frontend image
  inputs:
    command: build
    Dockerfile: frontend/Dockerfile
    tags: |
      $(acrLoginServer)/$(imageNameFrontend):$(Build.BuildId)
    buildContext: $(Build.SourcesDirectory)/frontend

# Push backend Docker image to ACR
- task: Docker@2
  displayName: Push backend image
  inputs:
    command: push
    repository: mycontactmanager
    tags: |
      $(acrLoginServer)/$(imageNameBackend):$(Build.BuildId)
    containerRegistry: $(acrLoginServer) 

# Push frontend Docker image to ACR
- task: Docker@2
  displayName: Push frontend image
  inputs:
    command: push
    repository: mycontactmanager  
    tags: |
      $(acrLoginServer)/$(imageNameFrontend):$(Build.BuildId)
    containerRegistry: $(acrLoginServer)   
